
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Android Cydia Hook。 | 岁月&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="岁月。">
    
    <meta name="description" content="利用Cydia Substrate在Android平台进行Hook。">
    
    
    
    
    
    <link rel="icon" href="/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="岁月&#39;s Blog" title="岁月&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="岁月&#39;s Blog">岁月&#39;s Blog</a></h1>
				<h2 class="blog-motto">一只奋斗的猿</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:blog.injectxx.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/23/Cydia Hook。/" title="Android Cydia Hook。" itemprop="url">Android Cydia Hook。</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://blog.injectxx.com" title="岁月。">岁月。</a>
    </p>
  <p class="article-time">
    <time datetime="2016-08-22T17:02:02.000Z" itemprop="datePublished">2016-08-23</time>
    Updated:<time datetime="2016-08-23T18:03:27.000Z" itemprop="dateModified">2016-08-24</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
		</div>
		
		<p>利用Cydia Substrate在Android平台进行Hook。<br><a id="more"></a><br>Substrate API说明：<br>1）MS.hookClassLoad<br>函数原型：void hookClassLoad(String name, MS.ClassLoadHook hook);<br>参数1：包名+类名，使用java的.符号。<br>参数2：MS.ClassLoadHook的一个实例，当这个类被加载的时候，它的 classLoaded 方法会被执行。<br>2)MS.hookMethod<br>函数原型：void hookMethod(Class _class, Member member, MS.MethodHook hook, MS.MethodPointer old);<br>参数1：加载的目标类，为classLoaded传下来的类参数。<br>参数2：通过反射得到的需要hook的方法(或构造函数). 注意：不能HOOK字段 (在编译的时候会进行检测).<br>参数3：MS.MethodHook的一个实例，其包含的invoked方法会被调用，用以代替member中的代码<br>参数4：函数指针<br>void hookMethod(Class _class, Member member, MS.MethodAlteration alteration);<br>参数1：加载的目标类，为classLoaded传下来的类参数。<br>参数2：通过反射得到的需要hook的方法(或构造函数). 注意：不能HOOK字段 (在编译的时候会进行检测).<br>参数3：An instance of MS.MethodAlteration whose boxedinvoked method will be called instead of member. This instance will also be filled in using information from   the original implementation, allowing you to use invoke to call the original method implementation.</p>
<p>例子：<br>1）创建一个工程。<br>2）导入substrate-api.jar文件到libs文件夹。<br>3）修改Mainfest文件。<br><figure class="highlight plain"><figcaption><span>xml</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    package=&quot;com.example.cydiahook&quot;&gt;</div><div class="line"></div><div class="line">    &lt;application</div><div class="line">        android:allowBackup=&quot;true&quot;</div><div class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</div><div class="line">        android:label=&quot;@string/app_name&quot;</div><div class="line">        android:supportsRtl=&quot;true&quot;</div><div class="line">        android:theme=&quot;@style/AppTheme&quot;&gt;</div><div class="line">        &lt;meta-data android:name=&quot;com.saurik.substrate.main&quot; android:value=&quot;example.Main&quot;/&gt;</div><div class="line">        &lt;activity android:name=&quot;.MainActivity&quot;&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</div><div class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">        &lt;uses-permission android:name=&quot;cydia.permission.SUBSTRATE&quot;/&gt;</div><div class="line">    &lt;/application&gt;</div><div class="line"></div><div class="line">&lt;/manifest&gt;</div></pre></td></tr></table></figure></p>
<p>在Application之间添加 <meta-data android:name="com.saurik.substrate.main" android:value="example.Main">，，之后在添加 <uses-permission android:name="cydia.permission.SUBSTRATE">，这个为默认。<br>4）新建一个类，类名为Main，类中包含一个static方法initialize，当插件被加载的时候，该方法中的代码就会运行，完成一些必要的初始化工作，为了实现HOOK，达到修改目标类中的代码的目的，我们需要得到目标类的一个实例，例如resources，通过MS.MethodHook实例实现原代码的修改。为了调用原来代码中的方法，我们需要创建一个MS.MethodPointer类的实例，它可以在任何时候运行原来的代码。在这里我们通过对原代码中resources对象原始代码的调用和修改，这样就完成了一个简单的Hook。<br><figure class="highlight plain"><figcaption><span>Java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    static void initalize()&#123;</div><div class="line">        MS.hookClassLoad(&quot;android.content.res.Resources&quot;, new MS.ClassLoadHook()&#123;</div><div class="line">            public void classLoaded(Class&lt;?&gt; res) &#123;</div><div class="line">                Method getColor;</div><div class="line">                try &#123;</div><div class="line">                    getColor = res.getDeclaredMethod(&quot;getColor&quot;,Integer.TYPE);</div><div class="line">                &#125;catch (Exception e)&#123;</div><div class="line">                    getColor = null;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (getColor != null)&#123;</div><div class="line">                    final MS.MethodPointer old = new MS.MethodPointer();</div><div class="line">                    MS.hookMethod(res,getColor,new MS.MethodHook()&#123;</div><div class="line">                        public  Object invoked(Object res,Object... args)</div><div class="line">                            throws Throwable</div><div class="line">                        &#123;</div><div class="line">                            return (int)old.invoke(res,args)&amp; ~0x0000ff00 | 0x00ff0000;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,old);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></uses-permission></meta-data></p>
<p>例子来源于官网：<a href="http://www.cydiasubstrate.com/id/20cf4700-6379-4a14-9bc2-853fde8cc9d1/" target="_blank" rel="external">http://www.cydiasubstrate.com/id/20cf4700-6379-4a14-9bc2-853fde8cc9d1/</a></p>
<p>这是一种方式，还有一种方式是基于Xposed的，今天有点儿晚了，明天继续学习，晚安。<br>每天努力一点点儿。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/Hook/">Hook</a><a href="/tags/Cydia/">Cydia</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://blog.injectxx.com/2016/08/23/Cydia Hook。/" data-title="Android Cydia Hook。 | 岁月&#39;s Blog" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/08/24/Xposed Hook/" title="Android Xposed Hook。">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Android Xposed Hook。</span>
</a>
</div>


<div class="next">
<a href="/2016/08/21/关于调试权限清0。/"  title="关于调试权限清0。">
 <strong>NEXT:</strong><br/> 
 <span>关于调试权限清0。
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>5</sup></a></li>
		
			<li><a href="/tags/C/" title="C++">C++<sup>7</sup></a></li>
		
			<li><a href="/tags/C-C/" title="C/C++">C/C++<sup>1</sup></a></li>
		
			<li><a href="/tags/Cydia/" title="Cydia">Cydia<sup>1</sup></a></li>
		
			<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/Hook/" title="Hook">Hook<sup>3</sup></a></li>
		
			<li><a href="/tags/Windows/" title="Windows">Windows<sup>2</sup></a></li>
		
			<li><a href="/tags/Xposed/" title="Xposed">Xposed<sup>1</sup></a></li>
		
			<li><a href="/tags/inject/" title="inject">inject<sup>2</sup></a></li>
		
			<li><a href="/tags/函数替换/" title="函数替换">函数替换<sup>1</sup></a></li>
		
			<li><a href="/tags/反汇编/" title="反汇编">反汇编<sup>7</sup></a></li>
		
			<li><a href="/tags/日常/" title="日常">日常<sup>1</sup></a></li>
		
			<li><a href="/tags/注入/" title="注入">注入<sup>1</sup></a></li>
		
			<li><a href="/tags/远程线程注入/" title="远程线程注入">远程线程注入<sup>1</sup></a></li>
		
			<li><a href="/tags/逆向/" title="逆向">逆向<sup>7</sup></a></li>
		
			<li><a href="/tags/驱动/" title="驱动">驱动<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="undefined" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2016 
		
		<a href="http://blog.injectxx.com" target="_blank" title="岁月。">岁月。</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"Kernel32Sun"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
